---
import Layout from '../../../layouts/Layout.astro';
--- 

<Layout title="إدارة الأقساط - المدير العام" showNavigation={false}>
    <!-- Installment Delete Modal -->
    <div id="delete-installment-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">تأكيد حذف القسط</h3>
            <p class="modal-text">هل أنت متأكد أنك تريد حذف هذا القسط؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="modal-actions">
                <button id="confirm-inst-delete-btn" class="modal-btn confirm-btn">نعم، حذف</button>
                <button id="cancel-inst-delete-btn" class="modal-btn cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Contract Delete Modal -->
    <div id="delete-contract-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">تأكيد حذف العقد</h3>
            <p class="modal-text-danger"><b>تحذير:</b> أنت على وشك حذف العقد بالكامل، بما في ذلك جميع الأقساط المسجلة تحته. هل أنت متأكد؟</p>
            <div class="modal-actions">
                <button id="confirm-contract-delete-btn" class="modal-btn confirm-btn">نعم، حذف العقد</button>
                <button id="cancel-contract-delete-btn" class="modal-btn cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <main class="dashboard-main">
        <div class="dashboard-container">
            <header class="dashboard-header">
                <div class="header-title">
                    <h1>سجلات الأقساط</h1>
                    <p>اضغط على العميل لعرض وتعديل أقساطه.</p>
                </div>
                <a href="/admin/installments/new" class="new-contract-btn">+ إضافة عقد جديد</a>
            </header>

            <div class="table-container">
                <div id="loading-indicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>جاري تحميل العقود...</p>
                </div>
                <table id="contracts-table" class="contracts-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>العميل</th>
                            <th>الوحدة</th>
                            <th>الأقساط</th>
                            <th>إجراءات العقد</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Rows will be injected by script -->
                    </tbody>
                </table>
                <div id="no-data-message" class="no-data-message" style="display: none;">
                    <p>لا توجد عقود لعرضها.</p>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import { db } from '../../../lib/firebase/client.js';
    import { collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "firebase/firestore";

    if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') {
        window.location.href = '/admin';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('table-body');
        const table = document.getElementById('contracts-table');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');
        
        const instModal = document.getElementById('delete-installment-modal');
        const confirmInstDeleteBtn = document.getElementById('confirm-inst-delete-btn');
        const cancelInstDeleteBtn = document.getElementById('cancel-inst-delete-btn');
        let installmentToDelete = null;

        const contractModal = document.getElementById('delete-contract-modal');
        const confirmContractDeleteBtn = document.getElementById('confirm-contract-delete-btn');
        const cancelContractDeleteBtn = document.getElementById('cancel-contract-delete-btn');
        let contractIdToDelete = null;

        const formatCurrency = (num) => (num || 0).toLocaleString('ar-EG', { style: 'currency', currency: 'EGP' });
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });

        async function loadContracts() {
            loadingIndicator.style.display = 'flex';
            table.style.display = 'none';
            noDataMessage.style.display = 'none';
            tableBody.innerHTML = '';

            try {
                const q = query(collection(db, "installments"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const contracts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (contracts.length === 0) {
                    noDataMessage.style.display = 'flex';
                    return;
                }

                renderContracts(contracts);
                table.style.display = 'table';
                
                // ** NEW: Check for hash after rendering **
                highlightContractFromUrl();

            } catch (error) {
                console.error("Error loading contracts: ", error);
                noDataMessage.querySelector('p').textContent = 'حدث خطأ أثناء تحميل البيانات.';
                noDataMessage.style.display = 'flex';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderContracts(contracts) {
            tableBody.innerHTML = '';
            contracts.forEach(contract => {
                const mainRow = document.createElement('tr');
                mainRow.className = 'contract-row';
                mainRow.dataset.contractId = contract.id;
                mainRow.innerHTML = `
                    <td class="expand-cell">
                        <div class="customer-name">${contract.customerName}</div>
                        <div class="customer-phone">${contract.customerPhone}</div>
                    </td>
                    <td class="expand-cell">${contract.type} - ${contract.location}</td>
                    <td class="expand-cell">${(contract.installments || []).length}</td>
                    <td class="contract-actions">
                        <button class="expand-btn" title="عرض/إخفاء الأقساط">عرض &darr;</button>
                        <button class="action-btn delete-contract-btn" title="حذف العقد بالكامل" data-contract-id="${contract.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </td>
                `;
                tableBody.appendChild(mainRow);

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-container-row';
                detailsRow.dataset.detailsFor = contract.id;
                detailsRow.style.display = 'none';
                
                let installmentsHTML = '<p>لا توجد أقساط مسجلة لهذا العقد.</p>';
                if (contract.installments && contract.installments.length > 0) {
                     installmentsHTML = `
                        <table class="nested-table">
                            <thead><tr><th>المبلغ</th><th>الاستحقاق</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                            <tbody>
                                ${contract.installments.map((inst, index) => `
                                    <tr>
                                        <td>${formatCurrency(inst.amount)}</td>
                                        <td>${formatDate(inst.dueDate)}</td>
                                        <td>
                                            <select class="status-select" data-contract-id="${contract.id}" data-inst-index="${index}">
                                                <option value="pending" ${inst.status === 'pending' ? 'selected' : ''}>مستحق</option>
                                                <option value="paid" ${inst.status === 'paid' ? 'selected' : ''}>تم الدفع</option>
                                            </select>
                                        </td>
                                        <td class="actions-cell">
                                            <button class="save-btn" style="display: none;">حفظ</button>
                                            <button class="action-btn edit-btn" title="تعديل القسط" data-contract-id="${contract.id}" data-inst-index="${index}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                            <button class="action-btn delete-inst-btn" title="حذف القسط" data-contract-id="${contract.id}" data-inst-index="${index}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                detailsRow.innerHTML = `<td colspan="4"><div class="details-wrapper">${installmentsHTML}</div></td>`;
                tableBody.appendChild(detailsRow);
            });
        }
        
        // ** NEW: Function to handle hash changes and highlight **
        function highlightContractFromUrl() {
            const contractId = window.location.hash.substring(1);
            if (!contractId) return;

            const contractRow = tableBody.querySelector(`.contract-row[data-contract-id="${contractId}"]`);
            if (contractRow) {
                const detailsRow = tableBody.querySelector(`.details-container-row[data-details-for="${contractId}"]`);
                const expandBtn = contractRow.querySelector('.expand-btn');

                // Expand the details view if it's not already open
                if (detailsRow && detailsRow.style.display === 'none') {
                    detailsRow.style.display = 'table-row';
                    expandBtn.innerHTML = 'إخفاء &uarr;';
                    contractRow.classList.add('active');
                }

                // Scroll and highlight
                setTimeout(() => { // Use timeout to allow rendering before scrolling
                    contractRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    contractRow.classList.add('highlight');
                    setTimeout(() => {
                        contractRow.classList.remove('highlight');
                    }, 2500); // Highlight for 2.5 seconds
                }, 100);
            }
        }

        tableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) {
                 const expandCell = e.target.closest('.expand-cell');
                 if(expandCell) {
                    const contractRow = expandCell.closest('.contract-row');
                    const cId = contractRow.dataset.contractId;
                    const detailsRow = tableBody.querySelector(`.details-container-row[data-details-for="${cId}"]`);
                    const expandBtn = contractRow.querySelector('.expand-btn');
                    const isHidden = detailsRow.style.display === 'none';
                    detailsRow.style.display = isHidden ? 'table-row' : 'none';
                    expandBtn.innerHTML = isHidden ? 'إخفاء &uarr;' : 'عرض &darr;';
                    contractRow.classList.toggle('active', isHidden);
                 }
                 return;
            }

            const contractId = button.dataset.contractId;
            const instIndexStr = button.dataset.instIndex;

            if (button.classList.contains('expand-btn')) {
                const contractRow = button.closest('.contract-row');
                const cId = contractRow.dataset.contractId;
                const detailsRow = tableBody.querySelector(`.details-container-row[data-details-for="${cId}"]`);
                const isHidden = detailsRow.style.display === 'none';
                detailsRow.style.display = isHidden ? 'table-row' : 'none';
                button.innerHTML = isHidden ? 'إخفاء &uarr;' : 'عرض &darr;';
                contractRow.classList.toggle('active', isHidden);
            } 
            else if (button.classList.contains('save-btn')) {
                const newStatus = button.dataset.newStatus;
                await updateInstallment(contractId, instIndexStr, { status: newStatus }, button);
            }
            else if (button.classList.contains('edit-btn')) {
                window.location.href = `/admin/installments/edit-installment?contractId=${contractId}&instIndex=${instIndexStr}`;
            }
            else if (button.classList.contains('delete-inst-btn')) {
                installmentToDelete = { contractId, instIndexStr };
                instModal.classList.add('visible');
            }
            else if (button.classList.contains('delete-contract-btn')) {
                contractIdToDelete = contractId;
                contractModal.classList.add('visible');
            }
        });

        tableBody.addEventListener('change', (e) => {
            const target = e.target;
            if (target && target.classList.contains('status-select')) {
                const saveBtn = target.closest('tr').querySelector('.save-btn');
                saveBtn.dataset.contractId = target.dataset.contractId;
                saveBtn.dataset.instIndex = target.dataset.instIndex;
                saveBtn.dataset.newStatus = target.value;
                saveBtn.style.display = 'inline-block';
            }
        });
        
        async function updateInstallment(contractId, instIndexStr, newValues, button) {
            if(button) {
                button.textContent = 'جاري...';
                button.disabled = true;
            }
            try {
                const instIndex = parseInt(instIndexStr, 10);
                const contractRef = doc(db, "installments", contractId);
                const contractSnap = await getDoc(contractRef);
                if (contractSnap.exists()) {
                    const contractData = contractSnap.data();
                    const updatedInstallments = [...contractData.installments];
                    updatedInstallments[instIndex] = { ...updatedInstallments[instIndex], ...newValues };
                    await updateDoc(contractRef, { installments: updatedInstallments });
                    if(button) {
                       button.textContent = 'حفظ';
                       button.style.display = 'none';
                    }
                } else { throw new Error('Contract not found'); }
            } catch (error) {
                 console.error("Error updating: ", error);
                 if(button) button.textContent = 'خطأ';
                 alert('فشل التحديث. الرجاء المحاولة مرة أخرى.');
            } finally {
                if(button) button.disabled = false;
            }
        }

        async function deleteInstallment() {
            if (!installmentToDelete) return;
            const { contractId, instIndexStr } = installmentToDelete;
            const instIndex = parseInt(instIndexStr, 10);

            confirmInstDeleteBtn.disabled = true;

            try {
                 const contractRef = doc(db, "installments", contractId);
                 const contractSnap = await getDoc(contractRef);
                 if (contractSnap.exists()) {
                    let installments = contractSnap.data().installments || [];
                    installments.splice(instIndex, 1);
                    await updateDoc(contractRef, { installments: installments });
                    await loadContracts();
                 }
            } catch (error) {
                console.error("Error deleting installment: ", error);
                alert("فشل حذف القسط.");
            } finally {
                instModal.classList.remove('visible');
                confirmInstDeleteBtn.disabled = false;
                installmentToDelete = null;
            }
        }

        async function deleteContract() {
            if (!contractIdToDelete) return;
            confirmContractDeleteBtn.disabled = true;

            try {
                await deleteDoc(doc(db, "installments", contractIdToDelete));
                await loadContracts();
            } catch (error) {
                 console.error("Error deleting contract: ", error);
                 alert("فشل حذف العقد.");
            } finally {
                contractModal.classList.remove('visible');
                confirmContractDeleteBtn.disabled = false;
                contractIdToDelete = null;
            }
        }

        confirmInstDeleteBtn.addEventListener('click', deleteInstallment);
        cancelInstDeleteBtn.addEventListener('click', () => instModal.classList.remove('visible'));
        instModal.addEventListener('click', (e) => e.target === instModal && instModal.classList.remove('visible'));

        confirmContractDeleteBtn.addEventListener('click', deleteContract);
        cancelContractDeleteBtn.addEventListener('click', () => contractModal.classList.remove('visible'));
        contractModal.addEventListener('click', (e) => e.target === contractModal && contractModal.classList.remove('visible'));

        // Initial load
        loadContracts();
    });
</script>

<style is:global>
:root {
    --page-bg: #f7f8fa;
    --card-bg: #ffffff;
    --primary-accent: #6d28d9;
    --danger-text: #dc2626;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --success-color: #10b981;
    --active-row-bg: #f5f3ff;
    --highlight-bg: #e0e7ff; /* Added for highlighting */
}

.dashboard-main { background-color: var(--page-bg); min-height: 100vh; direction: rtl; }
.dashboard-container { max-width: 1300px; margin: auto; padding: 2rem; }
.dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
.header-title h1 { font-size: 2rem; font-weight: 700; }
.header-title p { color: var(--text-secondary); }
.new-contract-btn { background-color: var(--primary-accent); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; }

.table-container { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
.contracts-table { width: 100%; border-collapse: collapse; }
.contracts-table th, .contracts-table td { padding: 1rem 1.25rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
.contracts-table thead th { background-color: #f9fafb; font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; }

.contract-row {
    transition: background-color 0.5s ease;
}
.contract-row.highlight {
    background-color: var(--highlight-bg);
}

.contract-row:not(.active):hover { background-color: #fafafa; }
.contract-row.active { background-color: var(--active-row-bg); }
.expand-cell { cursor: pointer; }
.customer-name { font-weight: 600; color: var(--text-primary); }
.customer-phone { font-size: 0.9rem; color: var(--text-secondary); }

.contract-actions { display: flex; align-items: center; gap: 0.75rem; }
.expand-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); font-weight: 600; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; }
.contract-row.active .expand-btn { background-color: var(--primary-accent); color: white; border-color: var(--primary-accent); }

.details-container-row td { padding: 0; background-color: #fafbff; }
.details-wrapper { padding: 1rem; border-top: 2px solid var(--primary-accent); }
.details-wrapper > p { padding: 1rem; text-align: center; color: var(--text-secondary); }

.nested-table { width: 100%; border-collapse: collapse; }
.nested-table th, .nested-table td { padding: 0.8rem 1rem; border-bottom: 1px solid #eef2ff; text-align: right; vertical-align: middle; }
.nested-table thead th { font-size: 0.85rem; background: transparent; }
.nested-table tbody tr:last-child td { border-bottom: none; }

.status-select { padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: white; font-family: inherit; font-weight: 600; width: 120px; }
.status-select:focus { border-color: var(--primary-accent); outline: none; }

.actions-cell { display: flex; align-items: center; gap: 0.5rem; }
.save-btn { background-color: var(--success-color); color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; white-space: nowrap; }
.save-btn:hover { background-color: #059669; }
.save-btn:disabled { background-color: #6ee7b7; cursor: not-allowed; }

.action-btn { background: transparent; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.25rem; transition: color 0.2s; }
.action-btn:hover { color: var(--text-primary); }
.edit-btn:hover { color: #2563eb; }
.delete-inst-btn:hover, .delete-contract-btn:hover { color: var(--danger-text); }

.loading-indicator, .no-data-message { display: flex; justify-content: center; align-items: center; padding: 3rem; gap: 1rem; flex-direction: column; color: var(--text-secondary); }
.spinner { width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
.modal-overlay.visible { opacity: 1; visibility: visible; }
.modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
.modal-text { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1rem; }
.modal-text-danger { font-size: 1rem; color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6; }
.modal-text-danger b { color: var(--danger-text); font-weight: 800; }
.modal-actions { display: flex; justify-content: center; gap: 1rem; }
.modal-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
.confirm-btn { background-color: var(--danger-text); color: white; }
.confirm-btn:hover:not(:disabled) { background-color: #b91c1c; }
.cancel-btn { background-color: var(--border-color); color: var(--text-primary); }

</style>